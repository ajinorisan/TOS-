local accountInfo = session.barrack.GetMyAccount()
local cnt = accountInfo:GetPCCount()

if g.layer ~= nil then
    local settingsLayerIndexMap = {}  -- レイヤーとインデックスのマップを作成

    -- settingsテーブルからレイヤーとインデックスの情報を取得してマップに格納
    for k, v in pairs(g.settings) do
        settingsLayerIndexMap[tostring(k)] = {
            layer = v.layer,
            index = v.index
        }
    end

    -- マップを使ってPC情報にレイヤーとインデックスを割り当てる
    for i = 0, cnt - 1 do
        local pcInfo = accountInfo:GetPCByIndex(i)
        local pcApc = pcInfo:GetApc()
        local pcName = pcApc:GetName()
        local pcSettings = settingsLayerIndexMap[tostring(pcName)]

        if pcSettings then
            pcSettings.layer = g.layer
            pcSettings.index = i
        end
    end
end

other_character_skill_list_save_settings()

-- キャラクター情報の取得
g.characters = {}
local bpcnt = accountInfo:GetBarrackPCCount()

-- settingsテーブルからキャラクター情報を取得
for i = 0, bpcnt - 1 do
    local pcInfo = accountInfo:GetBarrackPCByIndex(i)
    local pcName = pcInfo:GetName()
    local pcSettings = g.settings[pcName]

    if pcSettings then
        table.insert(g.characters, {
            name = pcName,
            layer = pcSettings.layer,
            index = pcSettings.index
        })
    end
end

-- キャラクター情報をレイヤーとインデックスでソート
table.sort(g.characters, function(a, b)
    if a.layer == b.layer then
        return a.index < b.index
    else
        return a.layer < b.layer
    end
end)